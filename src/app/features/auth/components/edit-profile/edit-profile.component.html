<div class="edit-profile-wrapper" [class.embedded]="embedded">
  <div class="edit-profile-panel" [class.embedded-panel]="embedded">
    <div class="header" *ngIf="!embedded">
      <h2 class="title">Editar Perfil</h2>
      <p class="subtitle">Actualiza tu información personal</p>
    </div>

    <!-- Mensaje de éxito -->
    <div *ngIf="successMessage" class="success-message">
      <svg class="success-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="22 4 12 14.01 9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <div class="success-content">
        <strong>¡Éxito!</strong>
        <p>{{ successMessage }}</p>
      </div>
    </div>

    <!-- Mensaje de error -->
    <div *ngIf="errorMessage" class="error-message">
      {{ errorMessage }}
    </div>

    <!-- Sección de Avatar -->
    <div class="avatar-section">
      <h3 class="avatar-title">Foto de Perfil</h3>
      <div class="avatar-container">
        <div class="avatar-preview">
          <img
            *ngIf="getCurrentAvatarUrl()"
            [src]="getCurrentAvatarUrl()"
            alt="Avatar"
            class="avatar-image"
          />
          <div *ngIf="!getCurrentAvatarUrl()" class="avatar-placeholder">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12h4m-2 2v-4M4 18v-1a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v1a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1Zm8-10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
            </svg>
          </div>
        </div>
        <div class="avatar-actions">
          <label
            *ngIf="!selectedFile"
            class="avatar-upload-btn"
            [class.uploading]="uploadingAvatar">
            <input
              type="file"
              accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
              (change)="onFileSelected($event)"
              [disabled]="uploadingAvatar || deletingAvatar"
              style="display: none;"
            />
            <span *ngIf="!uploadingAvatar">{{ hasSavedAvatar() ? 'Cambiar Foto' : 'Subir Foto' }}</span>
            <span *ngIf="uploadingAvatar">Subiendo...</span>
          </label>
          <button
            *ngIf="hasSavedAvatar() && !selectedFile"
            type="button"
            class="avatar-delete-btn"
            (click)="deleteAvatar()"
            [disabled]="uploadingAvatar || deletingAvatar">
            <span *ngIf="!deletingAvatar">Eliminar</span>
            <span *ngIf="deletingAvatar">Eliminando...</span>
          </button>
          <button
            *ngIf="selectedFile && !uploadingAvatar"
            type="button"
            class="avatar-save-btn"
            (click)="uploadAvatar()">
            Guardar Foto
          </button>
          <button
            *ngIf="selectedFile && !uploadingAvatar"
            type="button"
            class="avatar-cancel-btn"
            (click)="cancelAvatarSelection()">
            Cancelar
          </button>
        </div>
        <div *ngIf="avatarError" class="avatar-error">
          {{ avatarError }}
        </div>
        <p class="avatar-hint">Formatos permitidos: JPG, PNG, GIF, WEBP. Tamaño máximo: 5MB</p>
      </div>
    </div>

    <!-- Modal de Crop -->
    <div class="crop-modal" *ngIf="showCropModal" (click)="cancelCrop()">
      <div class="crop-modal-content" (click)="$event.stopPropagation()">
        <div class="crop-modal-header">
          <h3>Recortar Imagen</h3>
          <button type="button" class="close-btn" (click)="cancelCrop()" aria-label="Cerrar">×</button>
        </div>

        <div class="crop-modal-body">
          <image-cropper
            [imageFile]="imageFileForCropper"
            [maintainAspectRatio]="true"
            [aspectRatio]="1"
            [resizeToWidth]="400"
            [cropperMinWidth]="100"
            [roundCropper]="true"
            [onlyScaleDown]="true"
            [format]="'png'"
            [imageQuality]="90"
            [autoCrop]="true"
            [output]="'base64'"
            (imageCropped)="imageCropped($event)"
            (imageLoaded)="imageLoaded()"
            (cropperReady)="cropperReady()"
            (loadImageFailed)="loadImageFailed()">
          </image-cropper>
        </div>

        <div class="crop-modal-footer">
          <button type="button" class="cancel-btn" (click)="cancelCrop()">
            Cancelar
          </button>
          <button type="button" class="apply-btn" (click)="applyCrop()" [disabled]="!croppedImage">
            Aplicar Recorte
          </button>
        </div>
      </div>
    </div>

    <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="edit-profile-form">
      <!-- Nombre -->
      <div class="input-group">
        <svg class="input-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12h4m-2 2v-4M4 18v-1a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v1a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1Zm8-10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
        </svg>
        <input
          type="text"
          formControlName="firstName"
          placeholder="Nombre"
          class="input-field"
          [class.invalid]="isFieldInvalid('firstName')"
        />
        <div *ngIf="isFieldInvalid('firstName')" class="field-error">
          {{ getFieldError('firstName') }}
        </div>
      </div>

      <!-- Apellido -->
      <div class="input-group">
        <svg class="input-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12h4m-2 2v-4M4 18v-1a3 3 0 0 1 3-3h4a3 3 0 0 1 3 3v1a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1Zm8-10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
        </svg>
        <input
          type="text"
          formControlName="lastName"
          placeholder="Apellido"
          class="input-field"
          [class.invalid]="isFieldInvalid('lastName')"
        />
        <div *ngIf="isFieldInvalid('lastName')" class="field-error">
          {{ getFieldError('lastName') }}
        </div>
      </div>

      <!-- Email -->
      <div class="input-group">
        <svg class="input-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M4 4H20C21.1 4 22 4.9 22 6V18C22 19.1 21.1 20 20 20H4C2.9 20 2 19.1 2 18V6C2 4.9 2.9 4 4 4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M22 6L12 13L2 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <input
          type="email"
          formControlName="email"
          placeholder="Email"
          class="input-field"
          [class.invalid]="isFieldInvalid('email')"
        />
        <div *ngIf="isFieldInvalid('email')" class="field-error">
          {{ getFieldError('email') }}
        </div>
      </div>

      <!-- Teléfono -->
      <div class="input-group">
        <svg class="input-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 0 1 2-2h3.28a1 1 0 0 1 .948.684l1.498 4.493a1 1 0 0 1-.502 1.21l-2.257 1.13a11.042 11.042 0 0 0 5.516 5.516l1.13-2.257a1 1 0 0 1 1.21-.502l4.493 1.498a1 1 0 0 1 .684.949V19a2 2 0 0 1-2 2h-1C9.716 21 3 14.284 3 6V5Z"/>
        </svg>
        <input
          type="tel"
          formControlName="telephone"
          placeholder="Teléfono"
          class="input-field"
          [class.invalid]="isFieldInvalid('telephone')"
        />
        <div *ngIf="isFieldInvalid('telephone')" class="field-error">
          {{ getFieldError('telephone') }}
        </div>
      </div>

      <!-- Fecha de Nacimiento -->
      <div class="input-group">
        <svg class="input-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M16 2v4M8 2v4M3 10h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <input
          type="date"
          formControlName="dateBird"
          placeholder="Fecha de Nacimiento"
          class="input-field"
          [class.invalid]="isFieldInvalid('dateBird')"
        />
        <div *ngIf="isFieldInvalid('dateBird')" class="field-error">
          {{ getFieldError('dateBird') }}
        </div>
      </div>

      <div class="form-actions">
        <button *ngIf="!embedded" type="button" class="cancel-button" (click)="onCancel()" [disabled]="isLoading">
          Cancelar
        </button>
        <button type="submit" class="submit-button" [disabled]="isLoading">
          <span *ngIf="!isLoading">Guardar Cambios</span>
          <span *ngIf="isLoading">Guardando...</span>
        </button>
      </div>
    </form>
  </div>
</div>
