<div class="analytics-container">
  <!-- Header -->
  <div class="analytics-header">
    <div>
      <h1>Anal√≠ticas de {{ activeCategory === 'pages' ? 'P√°ginas' : 'Grupos' }}</h1>
      <p class="subtitle">Visualiza y analiza las m√©tricas de tus {{ activeCategory === 'pages' ? 'p√°ginas' : 'grupos' }} de Facebook</p>
    </div>
    <button 
      *ngIf="activeCategory === 'pages' && activeView === 'detailed'"
      class="sync-btn" 
      [class.syncing]="syncing"
      [disabled]="syncing || !selectedPage"
      (click)="syncPageMetrics()">
      <span class="sync-icon" *ngIf="!syncing">üîÑ</span>
      <span class="spinner" *ngIf="syncing"></span>
      <span>{{ syncing ? 'Sincronizando...' : 'Sincronizar' }}</span>
    </button>
  </div>

  <!-- Mensaje de progreso -->
  <div *ngIf="syncProgress" class="sync-progress" [class.error]="syncProgress.includes('Error')">
    {{ syncProgress }}
  </div>

  <!-- Tabs de Vista -->
  <div class="analytics-tabs">
    <button 
      class="tab-btn" 
      [class.active]="activeView === 'overview'"
      (click)="switchView('overview')">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
      </svg>
      <span>Vista General</span>
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeView === 'detailed'"
      (click)="switchView('detailed')">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
      </svg>
      <span>Vista Detallada</span>
    </button>
  </div>

  <!-- Contenido Principal -->
  <div class="analytics-content-wrapper">
      <!-- Loading State -->
      <div *ngIf="loading" class="loading-state">
        <div class="spinner-large"></div>
        <p>{{ activeCategory === 'pages' ? 'Cargando p√°ginas...' : 'Cargando grupos...' }}</p>
      </div>

      <!-- Error State -->
      <div *ngIf="!loading && error" class="error-state">
        <p>{{ error }}</p>
        <button (click)="activeCategory === 'pages' ? loadPages() : loadGroups()" class="retry-btn">Reintentar</button>
      </div>

      <!-- Vista General de P√°ginas con AG Grid -->
      <div *ngIf="activeCategory === 'pages' && activeView === 'overview' && !errorPages" class="overview-view">
        <div class="ag-grid-container">
          <div *ngIf="loadingGrid" class="grid-loading">
            <div class="spinner-large"></div>
            <p>Cargando datos...</p>
          </div>
          <ag-grid-angular
            *ngIf="!loadingGrid"
            style="width: 100%; height: 600px;"
            class="ag-theme-alpine"
            [columnDefs]="columnDefs"
            [rowData]="rowData"
            [gridOptions]="gridOptions"
            (gridReady)="onGridReady($event)">
          </ag-grid-angular>
          <div *ngIf="!loadingGrid && rowData.length === 0" class="empty-state">
            <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <p>No hay p√°ginas disponibles</p>
            <p class="empty-subtitle">Conecta p√°ginas de Facebook para ver sus m√©tricas</p>
          </div>
        </div>
      </div>

      <!-- Vista Detallada de P√°ginas -->
      <div *ngIf="activeCategory === 'pages' && activeView === 'detailed' && !errorPages" class="analytics-content">
        <div class="detailed-layout" *ngIf="pages.length > 0">
          <!-- Sidebar izquierdo: Lista de p√°ginas -->
          <aside class="pages-sidebar">
            <h3 class="sidebar-title">P√°ginas</h3>
            <div class="pages-list-vertical">
              <button
                *ngFor="let page of pages"
                class="page-btn-vertical"
                [class.active]="page.selected"
                (click)="selectPage(page)">
                <img 
                  *ngIf="page.pictureUrl" 
                  [src]="page.pictureUrl" 
                  [alt]="page.name"
                  class="page-thumb">
                <div *ngIf="!page.pictureUrl" class="page-thumb-placeholder">
                  {{ page.name.charAt(0).toUpperCase() }}
                </div>
                <div class="page-info-vertical">
                  <span class="page-name">{{ page.name }}</span>
                  <span class="page-id-small">ID: {{ page.facebookPageId }}</span>
                </div>
              </button>
            </div>
          </aside>

          <!-- Contenido principal: Controles y Gr√°fico -->
          <main class="detailed-content">
            <div *ngIf="selectedPage" class="metrics-section">
          <!-- Controles de Fecha -->
          <div class="controls-card">
            <div class="control-group">
              <label>Rango de fechas</label>
              <div class="date-inputs">
                <input
                  type="date"
                  [(ngModel)]="fromDate"
                  (change)="onDateRangeChange()"
                  class="date-input">
                <span>a</span>
                <input
                  type="date"
                  [(ngModel)]="toDate"
                  (change)="onDateRangeChange()"
                  class="date-input">
              </div>
            </div>

            <!-- Selector de M√©tricas -->
            <div class="control-group">
              <label>M√©tricas a mostrar</label>
              <div class="metrics-checkboxes">
                <label *ngFor="let metric of availableMetrics" class="metric-checkbox">
                  <input
                    type="checkbox"
                    [value]="metric.key"
                    [checked]="selectedMetricKeys.includes(metric.key)"
                    (change)="onMetricSelectionChange()"
                    (click)="toggleMetric(metric.key, $event)">
                  <span class="checkmark" [style.background-color]="metric.color + '20'" [style.border-color]="metric.color"></span>
                  <span>{{ metric.label }}</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Gr√°fico -->
          <div class="chart-card">
            <div class="chart-header">
              <h3>Evoluci√≥n de M√©tricas</h3>
              <span class="page-name-badge">{{ selectedPage.name }}</span>
            </div>
            
            <div *ngIf="selectedPage.loadingMetrics" class="chart-loading">
              <div class="spinner-medium"></div>
              <p>Cargando m√©tricas...</p>
            </div>

            <div *ngIf="!selectedPage.loadingMetrics && selectedPage.chartData && selectedPage.chartData.series.length > 0" class="chart-container">
              <div echarts [options]="chartOptions" class="echarts-chart"></div>
            </div>

            <div *ngIf="!selectedPage.loadingMetrics && (!selectedPage.chartData || selectedPage.chartData.series.length === 0)" class="no-metrics">
              <p>No hay m√©tricas disponibles para este rango de fechas</p>
              <button class="sync-page-btn" (click)="syncPageMetrics()">
                Sincronizar m√©tricas
              </button>
            </div>
          </div>

          <!-- Resumen de M√©tricas -->
          <div *ngIf="selectedPage.chartData && selectedPage.chartData.series.length > 0" class="metrics-summary">
            <h3>Resumen</h3>
            <div class="summary-grid">
              <div *ngFor="let metricSeries of selectedPage.chartData.series" class="summary-card">
                <div class="summary-header">
                  <span class="metric-label">{{ metricSeries.label }}</span>
                  <span class="metric-color" [style.background-color]="metricSeries.color"></span>
                </div>
                <div class="summary-values">
                  <div class="summary-item">
                    <span class="summary-label">Total</span>
                    <span class="summary-value">{{ formatNumber(metricSeries.statistics.total) }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Promedio</span>
                    <span class="summary-value">{{ formatNumber(getRoundedAverage(metricSeries.statistics.average)) }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">M√°ximo</span>
                    <span class="summary-value">{{ formatNumber(metricSeries.statistics.max) }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">M√≠nimo</span>
                    <span class="summary-value">{{ formatNumber(metricSeries.statistics.min) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
            </div>

          <!-- Empty State cuando no hay p√°gina seleccionada -->
          <div *ngIf="!selectedPage" class="empty-state">
            <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <p>Selecciona una p√°gina para ver sus m√©tricas detalladas</p>
          </div>
        </main>
        </div>

        <!-- Empty State cuando no hay p√°ginas -->
        <div *ngIf="pages.length === 0" class="empty-state">
          <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <p>No hay p√°ginas activas</p>
          <p class="empty-subtitle">Activa al menos una p√°gina para ver sus m√©tricas</p>
        </div>
      </div>

      <!-- Vista General de Grupos con AG Grid -->
      <div *ngIf="activeCategory === 'groups' && activeView === 'overview' && !errorGroups" class="overview-view">
        <div class="ag-grid-container">
          <div *ngIf="loadingGrid" class="grid-loading">
            <div class="spinner-large"></div>
            <p>Cargando datos...</p>
          </div>
          <ag-grid-angular
            *ngIf="!loadingGrid"
            style="width: 100%; height: 600px;"
            class="ag-theme-alpine"
            [columnDefs]="columnDefs"
            [rowData]="rowData"
            [gridOptions]="gridOptions"
            (gridReady)="onGridReady($event)">
          </ag-grid-angular>
          <div *ngIf="!loadingGrid && rowData.length === 0" class="empty-state">
            <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            <p>No hay grupos disponibles</p>
            <p class="empty-subtitle">Conecta grupos de Facebook para ver sus m√©tricas</p>
          </div>
        </div>
      </div>

      <!-- Vista Detallada de Grupos -->
      <div *ngIf="activeCategory === 'groups' && activeView === 'detailed' && !errorGroups" class="analytics-content">
        <div class="detailed-layout" *ngIf="groups.length > 0">
          <!-- Sidebar izquierdo: Lista de grupos -->
          <aside class="pages-sidebar">
            <h3 class="sidebar-title">Grupos</h3>
            <div class="pages-list-vertical">
              <button
                *ngFor="let group of groups"
                class="page-btn-vertical"
                [class.active]="group.selected"
                (click)="selectGroup(group)">
                <img 
                  *ngIf="group.pictureUrl" 
                  [src]="group.pictureUrl" 
                  [alt]="group.name"
                  class="page-thumb">
                <div *ngIf="!group.pictureUrl" class="page-thumb-placeholder">
                  {{ group.name.charAt(0).toUpperCase() }}
                </div>
                <div class="page-info-vertical">
                  <span class="page-name">{{ group.name }}</span>
                  <span class="page-id-small">ID: {{ group.facebookGroupId }}</span>
                </div>
              </button>
            </div>
          </aside>

          <!-- Contenido principal: Controles y Gr√°fico -->
          <main class="detailed-content">
            <div *ngIf="selectedGroup" class="metrics-section">
          <!-- Controles de Fecha -->
          <div class="controls-card">
            <div class="control-group">
              <label>Rango de fechas</label>
              <div class="date-inputs">
                <input
                  type="date"
                  [(ngModel)]="fromDate"
                  (change)="onDateRangeChange()"
                  class="date-input">
                <span>a</span>
                <input
                  type="date"
                  [(ngModel)]="toDate"
                  (change)="onDateRangeChange()"
                  class="date-input">
              </div>
            </div>

            <!-- Selector de M√©tricas -->
            <div class="control-group">
              <label>M√©tricas a mostrar</label>
              <div class="metrics-checkboxes">
                <label *ngFor="let metric of availableMetrics" class="metric-checkbox">
                  <input
                    type="checkbox"
                    [value]="metric.key"
                    [checked]="selectedMetricKeys.includes(metric.key)"
                    (change)="onMetricSelectionChange()"
                    (click)="toggleMetric(metric.key, $event)">
                  <span class="checkmark" [style.background-color]="metric.color + '20'" [style.border-color]="metric.color"></span>
                  <span>{{ metric.label }}</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Gr√°fico -->
          <div class="chart-card">
            <div class="chart-header">
              <h3>Evoluci√≥n de M√©tricas</h3>
              <span class="page-name-badge">{{ selectedGroup.name }}</span>
            </div>
            
            <div *ngIf="selectedGroup.loadingMetrics" class="chart-loading">
              <div class="spinner-medium"></div>
              <p>Cargando m√©tricas...</p>
            </div>

            <div *ngIf="!selectedGroup.loadingMetrics && selectedGroup.chartData && selectedGroup.chartData.series.length > 0" class="chart-container">
              <div echarts [options]="chartOptions" class="echarts-chart"></div>
            </div>

            <div *ngIf="!selectedGroup.loadingMetrics && (!selectedGroup.chartData || selectedGroup.chartData.series.length === 0)" class="no-metrics">
              <p>No hay m√©tricas disponibles para este rango de fechas</p>
              <p class="no-metrics-hint">Los datos se sincronizan autom√°ticamente cuando el grupo est√° activo</p>
            </div>
          </div>

          <!-- Resumen de M√©tricas -->
          <div *ngIf="selectedGroup.chartData && selectedGroup.chartData.series.length > 0" class="metrics-summary">
            <h3>Resumen</h3>
            <div class="summary-grid">
              <div *ngFor="let metricSeries of selectedGroup.chartData.series" class="summary-card">
                <div class="summary-header">
                  <span class="metric-label">{{ metricSeries.label }}</span>
                  <span class="metric-color" [style.background-color]="metricSeries.color"></span>
                </div>
                <div class="summary-values">
                  <div class="summary-item">
                    <span class="summary-label">Total</span>
                    <span class="summary-value">{{ formatNumber(metricSeries.statistics.total) }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Promedio</span>
                    <span class="summary-value">{{ formatNumber(getRoundedAverage(metricSeries.statistics.average)) }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">M√°ximo</span>
                    <span class="summary-value">{{ formatNumber(metricSeries.statistics.max) }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">M√≠nimo</span>
                    <span class="summary-value">{{ formatNumber(metricSeries.statistics.min) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
            </div>

          <!-- Empty State cuando no hay grupo seleccionado -->
          <div *ngIf="!selectedGroup" class="empty-state">
            <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            <p>Selecciona un grupo para ver sus m√©tricas detalladas</p>
          </div>
        </main>
        </div>

        <!-- Empty State cuando no hay grupos -->
        <div *ngIf="groups.length === 0" class="empty-state">
          <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
          </svg>
          <p>No hay grupos activos</p>
          <p class="empty-subtitle">Activa al menos un grupo para ver sus m√©tricas</p>
        </div>
      </div>
  </div>
</div>
