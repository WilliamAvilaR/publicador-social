<div class="conversation-container">
  <!-- Header -->
  <div class="conversation-header">
    <button class="back-btn" (click)="goBack()" title="Volver a la lista">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
    </button>
    
    <div class="header-info" *ngIf="conversation">
      <div class="header-avatar">
        <img 
          *ngIf="conversation.participantPictureUrl" 
          [src]="conversation.participantPictureUrl" 
          [alt]="conversation.participantName || 'Usuario'"
          class="avatar-img">
        <div 
          *ngIf="!conversation.participantPictureUrl"
          class="avatar-placeholder">
          {{ (conversation.participantName || 'U')[0].toUpperCase() }}
        </div>
      </div>
      <div class="header-details">
        <h2 class="participant-name">{{ conversation.participantName || 'Usuario sin nombre' }}</h2>
        <p class="participant-id" *ngIf="conversation.participantId">ID: {{ conversation.participantId }}</p>
      </div>
    </div>

    <div class="header-actions">
      <button 
        class="action-btn archive-btn" 
        (click)="archiveConversation(!conversation?.isArchived)"
        [title]="conversation?.isArchived ? 'Desarchivar' : 'Archivar'">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
        </svg>
        {{ conversation?.isArchived ? 'Desarchivar' : 'Archivar' }}
      </button>
    </div>
  </div>

  <!-- Loading state -->
  <div *ngIf="loading && messages.length === 0" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando mensajes...</p>
  </div>

  <!-- Error state -->
  <div *ngIf="error && messages.length === 0" class="error-state">
    <p>{{ error }}</p>
    <button (click)="loadMessages()" class="retry-btn">Reintentar</button>
  </div>

  <!-- Messages container -->
  <div 
    *ngIf="messages.length > 0 || !loading" 
    class="messages-container"
    #messagesContainer>
    <div class="messages-list">
      <div 
        *ngFor="let message of messages; let i = index"
        class="message-wrapper">
        
        <!-- Date separator -->
        <div *ngIf="shouldShowDateSeparator(i)" class="date-separator">
          <span>{{ formatMessageDate(message.createdTime) }}</span>
        </div>

        <!-- Message -->
        <div 
          class="message"
          [class.from-page]="message.isFromPage"
          [class.to-page]="!message.isFromPage">
          <div class="message-content">
            <p class="message-text">{{ message.message }}</p>
            <span class="message-time">{{ formatMessageTime(message.createdTime) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty state -->
  <div *ngIf="!loading && messages.length === 0 && !error" class="empty-state">
    <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
    </svg>
    <p>No hay mensajes en esta conversación</p>
  </div>

  <!-- Message input -->
  <div class="message-input-container" *ngIf="conversation">
    <div *ngIf="error && messages.length > 0" class="input-error">
      <p>{{ error }}</p>
    </div>
    <div class="input-wrapper">
      <textarea
        [(ngModel)]="newMessage"
        (keydown)="onKeyPress($event)"
        placeholder="Escribe un mensaje..."
        class="message-input"
        rows="1"
        [disabled]="sending"
        #messageInput></textarea>
      <button 
        class="send-btn"
        (click)="sendMessage()"
        [disabled]="!newMessage.trim() || sending">
        <span *ngIf="!sending">Enviar</span>
        <span *ngIf="sending" class="sending-text">Enviando...</span>
      </button>
    </div>
    <p class="input-hint">
      Presiona Enter para enviar, Shift+Enter para nueva línea
    </p>
  </div>
</div>
